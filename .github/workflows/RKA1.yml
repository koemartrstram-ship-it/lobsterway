name: RDP Access

on: 
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Duration (hours)'
        required: false
        default: '4'
        type: choice
        options:
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

env:
  NGROK_TOKEN: 2lYIJEGho1ExHGjJGPOnyN8N2Cz_3hv74cinmWnjjYrmQ5PB2
  RDP_USER: runneradmin
  RDP_PASS: P@ssw0rd123!

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Setup RDP
      shell: pwsh
      run: |
        Write-Host "ğŸ”§ Configuring RDP..." -ForegroundColor Cyan
        
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        
        Set-Service -Name "TermService" -StartupType Automatic
        Restart-Service -Name "TermService" -Force
        Start-Sleep -Seconds 2
        
        $securePass = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $securePass
        
        Write-Host "âœ… RDP ready - User: runneradmin"
    
    - name: Start Ngrok
      shell: pwsh
      run: |
        Write-Host "â¬‡ï¸ Downloading ngrok..." -ForegroundColor Cyan
        
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -Force
        
        .\ngrok\ngrok.exe config add-authtoken $env:NGROK_TOKEN
        
        Write-Host "ğŸš€ Starting tunnel..." -ForegroundColor Yellow
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
        
        Write-Host "â³ Waiting 10 seconds..."
        Start-Sleep -Seconds 10
    
    - name: Get Connection Info
      shell: pwsh
      run: |
        Write-Host "ğŸ” Getting connection details..." -ForegroundColor Cyan
        
        $found = $false
        
        for ($i = 1; $i -le 10; $i++) {
          try {
            $api = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 2 -ErrorAction Stop
            
            if ($api.tunnels -and $api.tunnels.Count -gt 0) {
              $url = $api.tunnels[0].public_url -replace "tcp://", ""
              $parts = $url -split ":"
              
              Write-Host ""
              Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•‘         ğŸ¯ RDP CONNECTION READY!        â•‘" -ForegroundColor Green
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•‘  Address: $($parts[0]):$($parts[1])" -ForegroundColor Cyan
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•‘  Username: runneradmin" -ForegroundColor Yellow
              Write-Host "â•‘  Password: $env:RDP_PASS" -ForegroundColor Yellow
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
              Write-Host ""
              Write-Host "ğŸ“‹ Command: mstsc /v:$($parts[0]):$($parts[1])" -ForegroundColor White
              Write-Host ""
              
              $found = $true
              break
            }
          } catch {
            Write-Host "  Attempt $i/10..." -ForegroundColor DarkGray
            Start-Sleep -Seconds 2
          }
        }
        
        if (-not $found) {
          Write-Host ""
          Write-Host "âš ï¸  Get from: https://dashboard.ngrok.com/tunnels/agents" -ForegroundColor Yellow
          Write-Host "User: runneradmin | Pass: $env:RDP_PASS" -ForegroundColor Cyan
        }
    
    - name: Keep Alive
      shell: pwsh
      run: |
        $hours = [int]"${{ github.event.inputs.duration_hours }}"
        if ($hours -le 0) { $hours = 4 }
        
        $endTime = (Get-Date).AddSeconds($hours * 3600)
        
        Write-Host ""
        Write-Host "ğŸ”„ Session running for $hours hours" -ForegroundColor Green
        Write-Host "â° Stops at: $($endTime.ToString('HH:mm:ss'))" -ForegroundColor Cyan
        Write-Host ""
        
        $lastCheck = Get-Date
        
        while ((Get-Date) -lt $endTime) {
          $now = Get-Date
          
          # Status every 30 min
          if ($now.Minute % 30 -eq 0 -and $now.Second -lt 30) {
            $left = [math]::Round(($endTime - $now).TotalMinutes)
            Write-Host "[$($now.ToString('HH:mm'))] Active - $left min left" -ForegroundColor DarkGray
          }
          
          # Light activity every 3 min
          if (($now - $lastCheck).TotalSeconds -ge 180) {
            1..50 | ForEach-Object { [math]::Sqrt($_) } | Out-Null
            $lastCheck = $now
          }
          
          Start-Sleep -Seconds 30
        }
        
        Write-Host "â±ï¸ Time's up!" -ForegroundColor Yellow
    
    - name: Cleanup
      if: always()
      shell: pwsh
      run: |
        Write-Host "ğŸ§¹ Cleanup..."
        Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
        Write-Host "âœ… Done"
