name: RDP Access

on: 
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Duration (hours)'
        required: false
        default: '4'
        type: choice
        options:
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

env:
  NGROK_TOKEN: 2lYIJEGho1ExHGjJGPOnyN8N2Cz_3hv74cinmWnjjYrmQ5PB2
  RDP_USER: runneradmin
  RDP_PASS: P@ssw0rd123!

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Setup RDP (Full Configuration)
      shell: pwsh
      run: |
        Write-Host "ğŸ”§ Setting up RDP service..." -ForegroundColor Cyan
        
        # 1. Registry settings
        Write-Host "  â€¢ Configuring registry..." -ForegroundColor Gray
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "fAllowSecProtocolNegotiation" -Value 0
        
        # 2. Firewall rules
        Write-Host "  â€¢ Enabling firewall rules..." -ForegroundColor Gray
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        New-NetFirewallRule -DisplayName "RDP Port 3389" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow -ErrorAction SilentlyContinue
        
        # 3. Set password
        Write-Host "  â€¢ Setting user password..." -ForegroundColor Gray
        $securePass = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $securePass
        
        # 4. Start RDP service
        Write-Host "  â€¢ Starting RDP service..." -ForegroundColor Gray
        Set-Service -Name "TermService" -StartupType Automatic
        Set-Service -Name "UmRdpService" -StartupType Automatic -ErrorAction SilentlyContinue
        Set-Service -Name "SessionEnv" -StartupType Automatic -ErrorAction SilentlyContinue
        
        Stop-Service -Name "TermService" -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2
        Start-Service -Name "TermService"
        Start-Service -Name "UmRdpService" -ErrorAction SilentlyContinue
        Start-Service -Name "SessionEnv" -ErrorAction SilentlyContinue
        
        # 5. Wait for RDP to be fully ready
        Write-Host "  â€¢ Waiting for RDP to initialize..." -ForegroundColor Gray
        Start-Sleep -Seconds 5
        
        # 6. Verify RDP is listening
        $rdpListening = Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue
        if ($rdpListening) {
          Write-Host "âœ… RDP service ready and listening on port 3389" -ForegroundColor Green
        } else {
          Write-Host "âš ï¸ RDP may not be fully ready yet" -ForegroundColor Yellow
        }
        
        Write-Host "âœ… Configuration complete" -ForegroundColor Green
        Write-Host "   User: runneradmin" -ForegroundColor Yellow
        Write-Host "   Pass: $env:RDP_PASS" -ForegroundColor Yellow
    
    - name: Start Ngrok
      shell: pwsh
      run: |
        Write-Host "â¬‡ï¸ Downloading ngrok..." -ForegroundColor Cyan
        
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -Force
        
        .\ngrok\ngrok.exe config add-authtoken $env:NGROK_TOKEN
        
        Write-Host "ğŸš€ Starting ngrok tunnel..." -ForegroundColor Yellow
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
        
        Write-Host "â³ Waiting for tunnel to establish (15 seconds)..." -ForegroundColor Gray
        Start-Sleep -Seconds 15
    
    - name: Get Connection Info
      shell: pwsh
      run: |
        Write-Host "ğŸ” Retrieving connection details..." -ForegroundColor Cyan
        
        $found = $false
        
        for ($i = 1; $i -le 12; $i++) {
          try {
            $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 3 -ErrorAction Stop
            
            if ($response.tunnels -and $response.tunnels.Count -gt 0) {
              $tunnel = $response.tunnels[0]
              $url = $tunnel.public_url -replace "tcp://", ""
              $parts = $url -split ":"
              $rdpHost = $parts[0]
              $rdpPort = $parts[1]
              
              Write-Host ""
              Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•‘          ğŸ¯ RDP READY TO CONNECT!         â•‘" -ForegroundColor Green
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•‘  Server:   $rdpHost" -ForegroundColor Cyan
              Write-Host "â•‘  Port:     $rdpPort" -ForegroundColor Cyan
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•‘  Username: runneradmin" -ForegroundColor Yellow
              Write-Host "â•‘  Password: $env:RDP_PASS" -ForegroundColor Yellow
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
              Write-Host ""
              Write-Host "ğŸ“‹ COMMAND TO CONNECT:" -ForegroundColor White
              Write-Host "   mstsc /v:$rdpHost`:$rdpPort" -ForegroundColor Cyan
              Write-Host ""
              Write-Host "â„¹ï¸  IMPORTANT NOTES:" -ForegroundColor Yellow
              Write-Host "   â€¢ Wait 30 seconds before connecting (RDP needs time)" -ForegroundColor Gray
              Write-Host "   â€¢ Click 'Yes' if you see certificate warning" -ForegroundColor Gray
              Write-Host "   â€¢ Don't save credentials" -ForegroundColor Gray
              Write-Host ""
              
              $found = $true
              break
            }
          } catch {
            Write-Host "  â³ Attempt $i/12 - waiting..." -ForegroundColor DarkGray
            Start-Sleep -Seconds 3
          }
        }
        
        if (-not $found) {
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Yellow
          Write-Host "âš ï¸  MANUAL CONNECTION REQUIRED" -ForegroundColor Yellow
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "1. Open: https://dashboard.ngrok.com/tunnels/agents" -ForegroundColor White
          Write-Host "2. Find TCP tunnel to port 3389" -ForegroundColor White
          Write-Host "3. Connect using:" -ForegroundColor White
          Write-Host "   Username: runneradmin" -ForegroundColor Cyan
          Write-Host "   Password: $env:RDP_PASS" -ForegroundColor Cyan
          Write-Host ""
        }
    
    - name: Keep Session Alive
      shell: pwsh
      run: |
        $hours = [int]"${{ github.event.inputs.duration_hours }}"
        if ($hours -le 0) { $hours = 4 }
        
        $endTime = (Get-Date).AddSeconds($hours * 3600)
        
        Write-Host ""
        Write-Host "ğŸ”„ Session will run for $hours hours" -ForegroundColor Green
        Write-Host "â° Auto-stop at: $($endTime.ToString('HH:mm:ss'))" -ForegroundColor Cyan
        Write-Host "ğŸ’¡ RDP connection is now stable and ready!" -ForegroundColor Green
        Write-Host ""
        
        $lastActivity = Get-Date
        
        while ((Get-Date) -lt $endTime) {
          $now = Get-Date
          $remaining = [math]::Round(($endTime - $now).TotalMinutes)
          
          # Status update every 30 minutes
          if ($now.Minute % 30 -eq 0 -and $now.Second -lt 30) {
            Write-Host "[$($now.ToString('HH:mm'))] Session active - $remaining minutes remaining" -ForegroundColor DarkGray
          }
          
          # Light background activity every 3 minutes
          if (($now - $lastActivity).TotalSeconds -ge 180) {
            1..50 | ForEach-Object { [math]::Sqrt($_) } | Out-Null
            $lastActivity = $now
          }
          
          Start-Sleep -Seconds 30
        }
        
        Write-Host ""
        Write-Host "â±ï¸ Session time limit reached" -ForegroundColor Yellow
        Write-Host "ğŸ‘‹ Goodbye!" -ForegroundColor Cyan
    
    - name: Cleanup
      if: always()
      shell: pwsh
      run: |
        Write-Host "ğŸ§¹ Cleaning up..." -ForegroundColor Gray
        Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
        Write-Host "âœ… Cleanup complete"
