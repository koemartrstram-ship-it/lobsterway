name: RDP Access

on: 
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Duration (hours)'
        required: false
        default: '4'
        type: choice
        options:
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

env:
  NGROK_TOKEN: 2lYIJEGho1ExHGjJGPOnyN8N2Cz_3hv74cinmWnjjYrmQ5PB2
  RDP_USER: runneradmin
  RDP_PASS: P@ssw0rd123!

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Setup RDP (Complete)
      shell: pwsh
      run: |
        Write-Host "ğŸ”§ Configuring RDP service..." -ForegroundColor Cyan
        
        # 1. Enable RDP in registry
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        
        # 2. Enable firewall rules
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # 3. Make sure RDP service is running
        Set-Service -Name "TermService" -StartupType Automatic
        Start-Service -Name "TermService"
        
        # 4. Set user password
        $securePass = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $securePass
        
        # 5. Disable NLA (Network Level Authentication) for easier connection
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        
        # 6. Restart RDP service to apply changes
        Restart-Service -Name "TermService" -Force
        Start-Sleep -Seconds 3
        
        Write-Host "âœ… RDP fully configured and running" -ForegroundColor Green
        Write-Host "   User: runneradmin" -ForegroundColor Yellow
        Write-Host "   Pass: $env:RDP_PASS" -ForegroundColor Yellow
    
    - name: Start Ngrok
      shell: pwsh
      run: |
        Write-Host "â¬‡ï¸ Downloading ngrok..." -ForegroundColor Cyan
        
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -Force
        
        .\ngrok\ngrok.exe config add-authtoken $env:NGROK_TOKEN
        
        Write-Host "ğŸš€ Starting tunnel..." -ForegroundColor Yellow
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout --log-level=info" -WindowStyle Hidden -RedirectStandardOutput "ngrok.log" -RedirectStandardError "ngrok-error.log"
        
        Write-Host "â³ Initializing (15 seconds)..."
        Start-Sleep -Seconds 15
    
    - name: Get Connection Info
      shell: pwsh
      run: |
        Write-Host "ğŸ” Retrieving connection details..." -ForegroundColor Cyan
        
        $foundConnection = $false
        
        # Try API first
        for ($i = 1; $i -le 10; $i++) {
          try {
            $apiResponse = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 2 -ErrorAction Stop
            
            if ($apiResponse.tunnels -and $apiResponse.tunnels.Count -gt 0) {
              $tunnelUrl = $apiResponse.tunnels[0].public_url
              
              if ($tunnelUrl) {
                $cleanUrl = $tunnelUrl -replace "tcp://", ""
                $urlParts = $cleanUrl -split ":"
                $rdpHost = $urlParts[0]
                $rdpPort = $urlParts[1]
                
                Write-Host ""
                Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
                Write-Host "â•‘                                          â•‘" -ForegroundColor Green
                Write-Host "â•‘         ğŸ¯ RDP CONNECTION READY!        â•‘" -ForegroundColor Green
                Write-Host "â•‘                                          â•‘" -ForegroundColor Green
                Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
                Write-Host "â•‘                                          â•‘" -ForegroundColor Green
                Write-Host "â•‘  Host: $rdpHost" -ForegroundColor Cyan
                Write-Host "â•‘  Port: $rdpPort" -ForegroundColor Cyan
                Write-Host "â•‘                                          â•‘" -ForegroundColor Green
                Write-Host "â•‘  Username: runneradmin" -ForegroundColor Yellow
                Write-Host "â•‘  Password: $env:RDP_PASS" -ForegroundColor Yellow
                Write-Host "â•‘                                          â•‘" -ForegroundColor Green
                Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
                Write-Host ""
                Write-Host "ğŸ“‹ COPY THIS COMMAND:" -ForegroundColor White
                Write-Host "   mstsc /v:$rdpHost`:$rdpPort" -ForegroundColor Cyan
                Write-Host ""
                Write-Host "âš ï¸  IMPORTANT: If Windows asks about certificate," -ForegroundColor Yellow
                Write-Host "   click 'Yes' or 'Connect anyway'" -ForegroundColor Yellow
                Write-Host ""
                
                $foundConnection = $true
                break
              }
            }
          } catch {
            Write-Host "  â³ Attempt $i/10..." -ForegroundColor DarkGray
            Start-Sleep -Seconds 2
          }
        }
        
        # Parse log as fallback
        if (-not $foundConnection) {
          Write-Host "âš ï¸ API unavailable - parsing logs..." -ForegroundColor Yellow
          Start-Sleep -Seconds 3
          
          if (Test-Path "ngrok.log") {
            $logText = Get-Content "ngrok.log" -Raw
            
            if ($logText -match 'url=tcp://([a-zA-Z0-9\.\-]+):(\d+)') {
              $rdpHost = $matches[1]
              $rdpPort = $matches[2]
              
              Write-Host ""
              Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•‘         ğŸ¯ RDP CONNECTION READY!        â•‘" -ForegroundColor Green
              Write-Host "â•‘            (via log parsing)            â•‘" -ForegroundColor Green
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•‘  Host: $rdpHost" -ForegroundColor Cyan
              Write-Host "â•‘  Port: $rdpPort" -ForegroundColor Cyan
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•‘  Username: runneradmin" -ForegroundColor Yellow
              Write-Host "â•‘  Password: $env:RDP_PASS" -ForegroundColor Yellow
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
              Write-Host ""
              Write-Host "ğŸ“‹ COPY THIS COMMAND:" -ForegroundColor White
              Write-Host "   mstsc /v:$rdpHost`:$rdpPort" -ForegroundColor Cyan
              Write-Host ""
              Write-Host "âš ï¸  IMPORTANT: If Windows asks about certificate," -ForegroundColor Yellow
              Write-Host "   click 'Yes' or 'Connect anyway'" -ForegroundColor Yellow
              Write-Host ""
              
              $foundConnection = $true
            }
          }
        }
        
        # Show manual steps if still failed
        if (-not $foundConnection) {
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Yellow
          Write-Host "âš ï¸  MANUAL CONNECTION" -ForegroundColor Yellow
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "1. Go to: https://dashboard.ngrok.com/tunnels/agents" -ForegroundColor White
          Write-Host "2. Find TCP tunnel to port 3389" -ForegroundColor White
          Write-Host "3. Copy the address (e.g., X.tcp.ngrok.io:XXXXX)" -ForegroundColor White
          Write-Host "4. Connect with:" -ForegroundColor White
          Write-Host "   User: runneradmin" -ForegroundColor Cyan
          Write-Host "   Pass: $env:RDP_PASS" -ForegroundColor Cyan
          Write-Host ""
        }
    
    - name: Keep Alive
      shell: pwsh
      run: |
        $sessionHours = [int]"${{ github.event.inputs.duration_hours }}"
        if ($sessionHours -le 0) { $sessionHours = 4 }
        
        $totalSeconds = $sessionHours * 3600
        $stopTime = (Get-Date).AddSeconds($totalSeconds)
        
        Write-Host ""
        Write-Host "ğŸ”„ Session active for $sessionHours hours" -ForegroundColor Green
        Write-Host "â° Will stop at: $($stopTime.ToString('HH:mm:ss'))" -ForegroundColor Cyan
        Write-Host ""
        
        $lastActivityTime = Get-Date
        $mainLoopInterval = 30
        $bgActivityInterval = 180
        
        while ((Get-Date) -lt $stopTime) {
          $currentTime = Get-Date
          $minutesLeft = [math]::Round(($stopTime - $currentTime).TotalMinutes)
          
          # Status every 30 minutes
          if ($currentTime.Minute % 30 -eq 0 -and $currentTime.Second -lt $mainLoopInterval) {
            Write-Host "[$($currentTime.ToString('HH:mm'))] Active - $minutesLeft min left" -ForegroundColor DarkGray
          }
          
          # Background activity
          if (($currentTime - $lastActivityTime).TotalSeconds -ge $bgActivityInterval) {
            1..100 | ForEach-Object { [math]::Sqrt($_) } | Out-Null
            
            if ((Get-Random -Maximum 4) -eq 0) {
              try {
                Invoke-WebRequest -Uri "https://api.github.com" -Method Head -TimeoutSec 2 -ErrorAction SilentlyContinue | Out-Null
              } catch {}
            }
            
            $lastActivityTime = $currentTime
          }
          
          # Check ngrok health
          $ngrokAlive = $false
          try {
            $testApi = Invoke-WebRequest -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 1 -ErrorAction SilentlyContinue
            if ($testApi.StatusCode -eq 200) {
              $ngrokAlive = $true
            }
          } catch {
            $ngrokRunning = Get-Process -Name "ngrok" -ErrorAction SilentlyContinue
            if ($ngrokRunning) {
              $ngrokAlive = $true
            }
          }
          
          if (-not $ngrokAlive) {
            Write-Host "âš ï¸ Ngrok stopped - restarting..." -ForegroundColor Yellow
            Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
            Start-Sleep -Seconds 5
          }
          
          Start-Sleep -Seconds $mainLoopInterval
        }
        
        Write-Host ""
        Write-Host "â±ï¸ Session expired" -ForegroundColor Yellow
    
    - name: Cleanup
      if: always()
      shell: pwsh
      run: |
        Write-Host "ğŸ§¹ Cleanup..." -ForegroundColor Gray
        Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
        Write-Host "âœ… Done"
