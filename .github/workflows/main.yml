name: RDP Access

on: 
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Duration (hours)'
        required: false
        default: '4'
        type: choice
        options:
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

env:
  NGROK_TOKEN: 2lYIJEGho1ExHGjJGPOnyN8N2Cz_3hv74cinmWnjjYrmQ5PB2
  RDP_USER: runneradmin
  RDP_PASS: P@ssw0rd123!

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Setup RDP
      shell: pwsh
      run: |
        Write-Host "ğŸ”§ Configuring RDP..." -ForegroundColor Cyan
        
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        
        # Set password for runneradmin
        $secPass = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $secPass
        
        Write-Host "âœ… RDP enabled for user: runneradmin"
    
    - name: Start Ngrok
      shell: pwsh
      run: |
        Write-Host "â¬‡ï¸ Downloading ngrok..." -ForegroundColor Cyan
        
        # Download and extract
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -Force
        
        # Configure
        .\ngrok\ngrok.exe config add-authtoken $env:NGROK_TOKEN
        
        # Start tunnel
        Write-Host "ğŸš€ Starting tunnel..." -ForegroundColor Yellow
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout --log-level=info" -WindowStyle Hidden -RedirectStandardOutput "ngrok.log" -RedirectStandardError "ngrok-error.log"
        
        Write-Host "â³ Waiting for tunnel to establish..."
        Start-Sleep -Seconds 8
        
        # Also start a web interface accessible version
        Start-Sleep -Seconds 2
    
    - name: Get Connection Info
      shell: pwsh
      run: |
        Write-Host "ğŸ” Retrieving connection details..." -ForegroundColor Cyan
        
        $maxAttempts = 15
        $attempt = 0
        $success = $false
        
        while (-not $success -and $attempt -lt $maxAttempts) {
          $attempt++
          
          try {
            # Try API
            $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 3 -ErrorAction Stop
            
            if ($response.tunnels -and $response.tunnels.Count -gt 0) {
              $tunnel = $response.tunnels[0]
              
              if ($tunnel.public_url) {
                $url = $tunnel.public_url -replace "tcp://", ""
                $parts = $url -split ":"
                $host = $parts[0]
                $port = $parts[1]
                
                Write-Host ""
                Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
                Write-Host "â•‘                                          â•‘" -ForegroundColor Green
                Write-Host "â•‘         ğŸ¯ RDP CONNECTION READY!        â•‘" -ForegroundColor Green
                Write-Host "â•‘                                          â•‘" -ForegroundColor Green
                Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
                Write-Host "â•‘                                          â•‘" -ForegroundColor Green
                Write-Host "â•‘  Host: $host" -ForegroundColor Cyan
                Write-Host "â•‘  Port: $port" -ForegroundColor Cyan
                Write-Host "â•‘                                          â•‘" -ForegroundColor Green
                Write-Host "â•‘  Username: $env:RDP_USER" -ForegroundColor Yellow
                Write-Host "â•‘  Password: $env:RDP_PASS" -ForegroundColor Yellow
                Write-Host "â•‘                                          â•‘" -ForegroundColor Green
                Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
                Write-Host ""
                Write-Host "ğŸ“‹ COPY THIS:" -ForegroundColor White
                Write-Host "   mstsc /v:$host`:$port" -ForegroundColor Cyan
                Write-Host ""
                
                $success = $true
                break
              }
            }
          } catch {
            # Ignore error, will retry
          }
          
          if (-not $success) {
            Write-Host "  â³ Attempt $attempt/$maxAttempts - Waiting..." -ForegroundColor DarkGray
            Start-Sleep -Seconds 4
          }
        }
        
        if (-not $success) {
          Write-Host ""
          Write-Host "âš ï¸ API unavailable - parsing logs..." -ForegroundColor Yellow
          
          # Parse ngrok log for URL
          if (Test-Path "ngrok.log") {
            Start-Sleep -Seconds 2
            $logContent = Get-Content "ngrok.log" -Raw
            
            if ($logContent -match 'url=tcp://([^:]+):(\d+)') {
              $host = $matches[1]
              $port = $matches[2]
              
              Write-Host ""
              Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•‘         ğŸ¯ RDP CONNECTION READY!        â•‘" -ForegroundColor Green
              Write-Host "â•‘         (from log parsing)              â•‘" -ForegroundColor Green
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•‘  Host: $host" -ForegroundColor Cyan
              Write-Host "â•‘  Port: $port" -ForegroundColor Cyan
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•‘  Username: $env:RDP_USER" -ForegroundColor Yellow
              Write-Host "â•‘  Password: $env:RDP_PASS" -ForegroundColor Yellow
              Write-Host "â•‘                                          â•‘" -ForegroundColor Green
              Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
              Write-Host ""
              Write-Host "ğŸ“‹ COPY THIS:" -ForegroundColor White
              Write-Host "   mstsc /v:$host`:$port" -ForegroundColor Cyan
              Write-Host ""
              
              $success = $true
            }
          }
          
          if (-not $success) {
            Write-Host ""
            Write-Host "Manual steps:" -ForegroundColor Cyan
            Write-Host "1. Open: https://dashboard.ngrok.com/tunnels/agents" -ForegroundColor White
            Write-Host "2. Find active TCP tunnel" -ForegroundColor White
            Write-Host "3. Use connection details:" -ForegroundColor White
            Write-Host "   User: $env:RDP_USER" -ForegroundColor Yellow
            Write-Host "   Pass: $env:RDP_PASS" -ForegroundColor Yellow
            Write-Host ""
            
            # Show ngrok log
            if (Test-Path "ngrok.log") {
              Write-Host "Ngrok log:" -ForegroundColor Gray
              Get-Content "ngrok.log" | Select-Object -Last 15
            }
          }
        }
    
    - name: Keep Alive
      shell: pwsh
      run: |
        $hours = [int]"${{ github.event.inputs.duration_hours }}"
        if ($hours -eq 0) { $hours = 4 }
        
        $duration = $hours * 3600
        $endTime = (Get-Date).AddSeconds($duration)
        
        Write-Host ""
        Write-Host "ğŸ”„ Session running for $hours hours" -ForegroundColor Green
        Write-Host "â° Auto-stop at: $($endTime.ToString('HH:mm:ss'))" -ForegroundColor Cyan
        Write-Host ""
        
        $lastActivity = Get-Date
        $checkInterval = 30  # Check every 30 seconds
        $activityInterval = 180  # Activity every 3 minutes
        
        while ((Get-Date) -lt $endTime) {
          $now = Get-Date
          $remaining = [math]::Round(($endTime - $now).TotalMinutes)
          
          # Status every 30 minutes
          if ($now.Minute % 30 -eq 0 -and $now.Second -lt $checkInterval) {
            Write-Host "[$($now.ToString('HH:mm'))] Active - $remaining min remaining" -ForegroundColor DarkGray
          }
          
          # Background activity
          if (($now - $lastActivity).TotalSeconds -ge $activityInterval) {
            1..100 | ForEach-Object { [math]::Sqrt($_) } | Out-Null
            
            if ((Get-Random -Maximum 4) -eq 0) {
              try {
                Invoke-WebRequest -Uri "https://api.github.com" -Method Head -TimeoutSec 2 -ErrorAction SilentlyContinue | Out-Null
              } catch {}
            }
            
            $lastActivity = $now
          }
          
          # Check ngrok health
          $ngrokProcess = Get-Process -Name "ngrok" -ErrorAction SilentlyContinue
          if (-not $ngrokProcess) {
            Write-Host "âš ï¸ Ngrok died - restarting..." -ForegroundColor Yellow
            Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
            Start-Sleep -Seconds 5
          }
          
          Start-Sleep -Seconds $checkInterval
        }
        
        Write-Host ""
        Write-Host "â±ï¸ Time limit reached - ending session" -ForegroundColor Yellow
    
    - name: Cleanup
      if: always()
      shell: pwsh
      run: |
        Write-Host "ğŸ§¹ Cleaning up..." -ForegroundColor Gray
        Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
        Write-Host "âœ… Done"
