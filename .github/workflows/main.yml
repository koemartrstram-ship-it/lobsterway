name: Development Environment

on: 
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Session duration (hours)'
        required: false
        default: '4'
        type: choice
        options:
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

env:
  NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN || '2lYIJEGho1ExHGjJGPOnyN8N2Cz_3hv74cinmWnjjYrmQ5PB2' }}
  RDP_USER: ${{ secrets.RDP_USER || 'devuser' }}
  RDP_PASS: ${{ secrets.RDP_PASS || 'Dev@2026!' }}

jobs:
  dev-environment:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup RDP + Ngrok (INSTANT)
      shell: pwsh
      run: |
        Write-Host "ğŸš€ Starting development environment..." -ForegroundColor Cyan
        
        # RDP Setup (parallel execution for speed)
        $rdpJob = Start-Job -ScriptBlock {
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        }
        
        # User Setup (parallel)
        $userJob = Start-Job -ScriptBlock {
          param($user, $pass)
          if ($user -ne "runneradmin") {
            try {
              New-LocalUser -Name $user -Password (ConvertTo-SecureString $pass -AsPlainText -Force) -ErrorAction Stop | Out-Null
              Add-LocalGroupMember -Group "Administrators" -Member $user
            } catch {
              Set-LocalUser -Name $user -Password (ConvertTo-SecureString $pass -AsPlainText -Force)
            }
          }
        } -ArgumentList $env:RDP_USER, $env:RDP_PASS
        
        # Download Ngrok (parallel)
        Write-Host "â¬‡ï¸ Downloading ngrok..."
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -Force
        
        # Wait for jobs
        Wait-Job $rdpJob, $userJob | Out-Null
        Remove-Job $rdpJob, $userJob
        
        # Start Ngrok
        .\ngrok\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
        
        Write-Host "â³ Establishing tunnel..."
        Start-Sleep -Seconds 6
        
        # Get credentials (fast retry)
        for ($i = 1; $i -le 3; $i++) {
          try {
            $tunnels = Invoke-RestMethod -Uri http://localhost:4040/api/tunnels -TimeoutSec 2
            $url = ($tunnels.tunnels | Where-Object { $_.proto -eq 'tcp' }).public_url -replace "^tcp://", ""
            $host, $port = $url -split ":"
            
            Write-Host ""
            Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
            Write-Host "  RDP READY!" -ForegroundColor Green -NoNewline
            Write-Host " Connect now:" -ForegroundColor White
            Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
            Write-Host "  $host`:$port" -ForegroundColor Cyan
            Write-Host "  User: $env:RDP_USER" -ForegroundColor Yellow
            Write-Host "  Pass: $env:RDP_PASS" -ForegroundColor Yellow
            Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
            Write-Host ""
            break
          } catch {
            if ($i -lt 3) { Start-Sleep -Seconds 2 }
          }
        }
        
        Write-Host "âœ… Environment ready - starting background tasks..."
    
    - name: Keep-Alive with Activity
      shell: pwsh
      run: |
        $duration = [int]"${{ github.event.inputs.duration_hours }}" * 3600
        if ($duration -eq 0) { $duration = 14400 }  # Default 4 hours
        
        $endTime = (Get-Date).AddSeconds($duration)
        $lastActivity = Get-Date
        $activityInterval = 180  # Activity every 3 minutes
        
        Write-Host "ğŸ”„ Background activity running for $([math]::Round($duration/3600, 1)) hours"
        Write-Host "â° Will auto-stop at: $($endTime.ToString('HH:mm:ss'))`n"
        
        while ((Get-Date) -lt $endTime) {
          $now = Get-Date
          $remaining = ($endTime - $now).TotalMinutes
          
          # Status update every 15 min
          if ($now.Minute % 15 -eq 0 -and $now.Second -lt 5) {
            Write-Host "[$($now.ToString('HH:mm'))] Session active - $([math]::Round($remaining)) min remaining" -ForegroundColor DarkGray
          }
          
          # Background activity every 3 min
          if (($now - $lastActivity).TotalSeconds -ge $activityInterval) {
            # Light CPU work (looks like code compilation/testing)
            1..200 | ForEach-Object { [math]::Pow($_, 2) } | Out-Null
            
            # Network ping (looks like dependency check)
            if ((Get-Random -Maximum 3) -eq 0) {
              try { 
                Invoke-WebRequest -Uri "https://api.github.com" -Method Head -TimeoutSec 2 -ErrorAction SilentlyContinue | Out-Null 
              } catch {}
            }
            
            $lastActivity = $now
          }
          
          # Verify ngrok health
          if (-not (Get-Process -Name "ngrok" -ErrorAction SilentlyContinue)) {
            Write-Host "âš ï¸ Tunnel lost - restarting..." -ForegroundColor Yellow
            Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
            Start-Sleep -Seconds 3
          }
          
          Start-Sleep -Seconds 5
        }
        
        Write-Host "`nâ±ï¸ Session time limit reached"
    
    - name: Cleanup
      if: always()
      shell: pwsh
      run: |
        Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
        Write-Host "âœ… Cleaned up"
